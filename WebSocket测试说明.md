# WebSocket消息转发测试说明

## 测试页面访问
访问地址：`http://localhost:5173/websocket-test` （根据你的前端开发服务器地址调整）

## 测试步骤

### 1. 准备工作
- 确保后端服务正在运行
- 准备两个有效的用户账号和对应的JWT token

### 2. 测试流程

1. **连接用户1（发送者）**
   - 输入用户1的ID和token
   - 点击"连接用户1"按钮
   - 观察日志显示连接成功

2. **连接用户2（接收者）**
   - 输入用户2的ID和token
   - 点击"连接用户2"按钮
   - 观察日志显示连接成功

3. **发送测试消息**
   - 在消息内容输入框中输入测试消息
   - 点击"发送消息到用户X"按钮
   - 观察日志显示发送状态

4. **验证消息接收**
   - 查看用户2的日志区域是否显示收到消息
   - 确认消息内容正确

## 预期结果

### 成功情况
- 用户1发送消息后，用户2的日志中显示收到消息
- 消息内容与发送的内容一致
- 消息中包含正确的发送者和接收者信息

### 失败排查

如果测试失败，请检查：

1. **连接问题**
   - 确认后端WebSocket服务是否正常运行
   - 检查网络连接是否正常

2. **认证问题**
   - 确认使用的token是有效的JWT token
   - 检查token是否包含正确的用户信息

3. **配置问题**
   - 确认WebSocket配置正确（已修复路由冲突）
   - 检查消息代理配置

4. **日志分析**
   - 查看浏览器控制台是否有错误信息
   - 查看后端控制台日志

## 技术细节

### 前端实现
- 使用独立的WebSocket实例为每个用户创建连接
- 订阅用户专属消息队列：`/user/{userId}/queue/messages`
- 发送消息到：`/app/chat/single`

### 后端实现
- 接收消息端点：`@MessageMapping("/chat/single")`
- 转发消息：`convertAndSendToUser(userId, "/queue/messages", message)`
- Spring自动路由：`/queue/messages` → `/user/{userId}/queue/messages`

### 消息格式
```json
{
  "senderId": 1,
  "receiverId": 2,
  "content": "测试消息",
  "messageType": "TEXT",
  "timestamp": "2023-12-01T10:30:00Z"
}
```

## 常见问题

### Q: 用户2收不到消息
A: 检查：
1. 用户2的连接状态是否正常
2. 用户ID是否正确
3. 后端是否有发送成功的日志

### Q: 连接失败
A: 检查：
1. Token是否有效
2. WebSocket端点配置是否正确
3. 跨域配置是否正确

### Q: 消息格式错误
A: 确保发送的消息符合预期的JSON格式

## 调试技巧

1. **浏览器开发者工具**
   - 查看Network标签中的WebSocket连接
   - 查看Console标签中的错误信息

2. **后端日志**
   - 查看Spring Boot控制台输出
   - 关注WebSocket相关的日志信息

3. **消息追踪**
   - 在前端和后端都添加详细的日志输出
   - 使用唯一标识追踪消息流转

通过这个测试页面，你可以验证WebSocket消息转发功能是否正常工作，以及用户间的实时通信是否畅通。