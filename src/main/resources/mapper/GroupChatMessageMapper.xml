<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.travel.dao.GroupChatMessageDao">

    <resultMap id="groupChatMessageResultMap" type="com.example.travel.entity.GroupChatMessage">
        <id column="id" property="id" />
        <result column="group_id" property="groupId" />
        <result column="sender_id" property="senderId" />
        <result column="content" property="content" />
        <result column="message_type" property="messageType" />
        <result column="send_time" property="sendTime" />
        <result column="status" property="status" />
    </resultMap>

    <!-- 根据ID查询消息 -->
    <select id="findById" resultMap="groupChatMessageResultMap"> SELECT * FROM group_chat_messages
        WHERE id = #{id} </select>

    <!-- 根据群组ID查询消息 -->
    <select id="findByGroupId" resultMap="groupChatMessageResultMap"> SELECT * FROM
        group_chat_messages WHERE group_id = #{groupId} ORDER BY send_time DESC </select>

    <!-- 根据群组ID查询消息（分页） -->
    <select id="findByGroupIdWithLimit" resultMap="groupChatMessageResultMap"> SELECT * FROM
        group_chat_messages WHERE group_id = #{groupId} ORDER BY send_time DESC LIMIT #{limit} </select>

    <!-- 根据发送者ID查询消息 -->
    <select id="findBySenderId" resultMap="groupChatMessageResultMap"> SELECT * FROM
        group_chat_messages WHERE sender_id = #{senderId} ORDER BY send_time DESC </select>

    <!-- 新增消息 -->
    <insert id="insert" parameterType="com.example.travel.entity.GroupChatMessage"
        useGeneratedKeys="true" keyProperty="id"> INSERT INTO group_chat_messages (group_id,
        sender_id, content, message_type, send_time, status) VALUES (#{groupId}, #{senderId},
        #{content}, #{messageType}, #{sendTime}, #{status}) </insert>

    <!-- 更新消息状态 -->
    <update id="updateStatus"> UPDATE group_chat_messages SET status = #{status} WHERE id = #{id} </update>

    <!-- 删除消息 -->
    <delete id="delete"> DELETE FROM group_chat_messages WHERE id = #{id} </delete>

    <!-- 统计群组消息数量 -->
    <select id="countByGroupId" resultType="int"> SELECT COUNT(*) FROM group_chat_messages WHERE
        group_id = #{groupId} </select>

    <!-- 统计用户未读群消息数量 -->
    <select id="countUnreadMessages" resultType="int"> SELECT COUNT(*) FROM group_chat_messages gcm
        WHERE gcm.group_id = #{groupId} AND gcm.status = 1 AND gcm.send_time > COALESCE( (SELECT
        last_read_message_time FROM group_members WHERE group_id = #{groupId} AND user_id =
        #{userId}), '1970-01-01' ) </select>

</mapper>